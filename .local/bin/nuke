#!/usr/bin/env sh
GUI="${GUI:-1}"
BIN="${BIN:-0}"

set -euf -o noclobber -o noglob -o nounset
IFS="$(printf '%b_' '\n')"; IFS="${IFS%_}" # protect trailing \n

PATH=$PATH:"${XDG_CONFIG_HOME:-$HOME/.config}/nnn/plugins"

FPATH="$1"
FNAME=$(basename "$1")
EDITOR="nano"
PAGER="${PAGER:-less -R}"
ext="${FNAME##*.}"
if [ -n "$ext" ]; then
    ext="$(printf "%s" "${ext}" | tr '[:upper:]' '[:lower:]')"
fi

handle_pdf() {
        if type zathura >/dev/null 2>&1; then
             zathura "${FPATH}" >/dev/null 2>&1
            return
        fi
    exit 0
}

handle_av() {
        if type mpv >/dev/null 2>&1; then
            mpv --player-operation-mode=pseudo-gui  "${FPATH}" >/dev/null 2>&1 &
        fi
    exit 0
}

# handle this extension and exit
handle_extension() {
        ## PDF
        pdf)
            handle_pdf
            exit 1;;

        ## Audio
        aac|flac|m4a|mid|midi|mpa|mp2|mp3|ogg|wav|wma)
            handle_av
            exit 1;;

        ## Video
        avi|mkv|mp4|ts)
            handle_av
            exit 1;;
    esac
}

# sets the variable abs_target, this should be faster than calling printf
abspath() {
    case "$1" in
        /*) abs_target="$1";;
        *)  abs_target="$PWD/$1";;
    esac
}

# storing the result to a tmp file is faster than calling listimages twice
listimages() {
    find -L "///${1%/*}" -maxdepth 1 -type f -print0 |
        grep -izZE '\.(jpe?g|png|gif|webp|tiff|bmp|ico|svg)$' |
        sort -z | tee "$tmp"
}

load_dir() {
    abspath "$2"
    tmp="${TMPDIR:-/tmp}/nuke_$$"
    trap 'rm -f $tmp' EXIT
    count="$(listimages "$abs_target" | grep -a -m 1 -ZznF "$abs_target" | cut -d: -f1)"

    if [ -n "$count" ]; then
        if [ "$GUI" -ne 0 ]; then
            xargs -0 nohup "$1" -n "$count" -- < "$tmp"
        else
            xargs -0 "$1" -n "$count" -- < "$tmp"
        fi
    else
        shift
        "$1" -- "$@" # fallback
    fi
}

handle_multimedia() {
    mimetype="${1}"
    case "${mimetype}" in
        ## Image
        image/*)
                if type mvi >/dev/null 2>&1; then
                      mvi  "${FPATH}" >/dev/null 2>&1 &
                    exit 0
                fi
            exit 1;;

        ## PDF
        application/pdf)
            handle_pdf
            exit 1;;

        ## Audio
        audio/*)
            handle_av
            exit 1;;

        ## Video
        video/*)
            handle_av
            exit 1;;
    esac
}

handle_mime() {
    mimetype="${1}"
    case "${mimetype}" in
        ## Text
        text/* | */xml)
            "$EDITOR" "${FPATH}"
            exit 0;;
    esac
}

handle_fallback() {
    if [ "$GUI" -ne 0 ]; then
        if type xdg-open >/dev/null 2>&1; then
            nohup xdg-open "${FPATH}" >/dev/null 2>&1 &
            exit 0
        fi
    fi

    echo '----- File details -----' && file --dereference --brief -- "${FPATH}"
    exit 1
}

MIMETYPE="$( file -bL --mime-type -- "${FPATH}" )"
handle_multimedia "${MIMETYPE}"
handle_extension
handle_fallback

exit 1
